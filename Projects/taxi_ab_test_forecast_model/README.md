# A/B/C-тестирование новой модели прогноза времени ожидания в сервисе такси «Карету мне»

## Описание проекта
Сервис такси «Карету мне» столкнулся с проблемой: пассажиры часто отменяют заказы, если предварительное время ожидания машины не совпадает с реальным. Для решения проблемы разработана новая математическая модель, которая должна более точно прогнозировать время ожидания. Модель реализована в двух вариантах с небольшими различиями.

**Гипотеза:** Более точный прогноз времени ожидания повысит качество пользовательского опыта, что увеличит вероятность того, что заказ завершится поездкой.

**Задачи исследования:**
- Определить и рассчитать параметры теста
- Оценить корректность проведения теста
- Проанализировать результаты теста
- Подготовить рекомендации по внедрению

## Навыки и инструменты
- **Python:** Pandas, NumPy, Matplotlib, SciPy
- **Статистика:** A/B-тестирование, t-тест Стьюдента, линеаризация метрик, поправка Бонферрони
- **Метрики:** конверсия из заказа в поездку, выручка на пользователя, количество поездок на пользователя

## Набор данных

### `users` — метаданные пользователей
- `user_id` — уникальный идентификатор пользователя
- `registration_date` — дата регистрации
- `country_code` — код страны (RU, BY, KZ, UZ)
- `traffic_type` — источник привлечения (organic, paid, referral)
- `platform` — платформа (android, ios)

### `events` — пользовательские события
- `user_id` — идентификатор пользователя
- `time` — время события
- `session_id` — идентификатор сессии
- `event_name` — название события (app_start, registration_complete, order_initiate, order_create, order_cancel, order_rate)

### `orders` — метаданные о поездках
- `user_id` — идентификатор пользователя
- `order_id` — идентификатор заказа
- `order_time` — время создания заказа
- `ride_start_time` — время старта поездки
- `ride_finish_time` — время завершения поездки
- `status` — статус заказа (completed, cancelled_order_by_client, cancelled_order_by_driver)
- `paid_amt` — стоимость заказа
- `payment_type` — тип оплаты (cash, card, na)

### `split_data` — данные о сплите пользователей по группам
- `user_id` — идентификатор пользователя
- `time` — время попадания в группу
- `group_name` — группа (control, treatment_1, treatment_2)

---

## Параметры эксперимента

| Параметр | Значение |
|----------|----------|
| **Период проведения** | 14.10.2024 — 27.10.2024 (14 дней) |
| **Группы** | control, treatment_1, treatment_2 (сплит 33/33/33) |
| **Ключевая метрика** | Конверсия из создания заказа в успешную поездку |
| **Барьерная метрика** | Выручка на пользователя |
| **Вспомогательные метрики** | Конверсия из просмотра формы в создание заказа; Количество поездок на пользователя |
| **MDE (относительный)** | 4% |
| **MDE (абсолютный)** | 0.0319 |
| **Уровень значимости (α)** | 0.05 / 3 = 0.0167 (поправка Бонферрони) |
| **Мощность теста (1-β)** | 0.8 |
| **Статистический критерий** | t-тест Стьюдента с линеаризацией |
| **Доля трафика на тест** | 50% |

---

## Ход выполнения проекта

### Урок 3. Подготовка к тесту

**Выбор метрик:**
- **Ключевая метрика:** конверсия из создания заказа в успешную поездку (отражает вероятность завершения заказа)
- **Барьерная метрика:** выручка на пользователя (чтобы отследить негативное влияние на доход)
- **Вспомогательные метрики:** конверсия из просмотра формы в создание заказа; количество поездок на пользователя

**Дополнительные условия:**
- Поправка на множественное тестирование (Бонферрони)
- Линеаризация ключевой метрики (ratio-метрика)

### Урок 4. Дизайн теста

**Расчёт MDE для разных уровней трафика:**

Проведён расчёт MDE для различных долей трафика (от 10% до 90%) на предэкспериментальном периоде (23.09.2024 — 06.10.2024).

| Доля трафика | Относительный MDE |
|--------------|-------------------|
| 10% | > 4% |
| 20% | > 4% |
| 30% | > 4% |
| 40% | 4.08% |
| **50%** | **3.65%** |
| 60% | < 3.5% |

**Вывод:** Для достижения целевого MDE (≤ 4%) необходимо выделить на тест **50% трафика**.

### Урок 5. Отслеживание проведения теста

#### Задание 1. Очистка сплита пользователей
Из таблицы `split_data` удалены пользователи, попавшие в несколько групп одновременно. Очищенный датасет `split_data_correct` использован для дальнейшего анализа.

#### Задание 2. Подготовка данных
- Отфильтрованы заказы и события за период эксперимента
- Удалены заказы со статусом `cancelled_by_driver`
- К каждому заказу и событию добавлен признак группы пользователя

#### Задание 3. Кумулятивная ключевая метрика

**График конверсии из заказа в успешную поездку:**

**Выводы по графику:**
- Группа `treatment_1` демонстрирует устойчивый рост конверсии после 20 октября, к концу периода показывает лучшие результаты
- Группа `control` остаётся стабильной на всём протяжении эксперимента (хорошая опорная точка)
- До 20 октября все группы показывали схожую динамику

#### Задание 4. Кумулятивная барьерная метрика

**График выручки на пользователя:**

**Выводы по графику:**
- У группы `treatment_2` барьерная метрика ухудшается (значения ниже контрольной группы)
- Группа `treatment_1` демонстрирует схожую с контролем динамику, к концу периода даже опережает контроль
- Барьерная метрика в группе `treatment_1` не снижается

### Урок 6. Подведение итогов теста

#### Задание 1. Расчёт ключевой метрики (попарное сравнение)

**Результаты сравнения групп:**

| Группа A | Группа B | p-value | Mean A | Mean B | Абсолютный Lift | Относительный Lift (%) |
|----------|----------|---------|--------|--------|-----------------|----------------------|
| control | treatment_1 | **0.000182** | 0.8705 | 0.9044 | +0.0338 | **+3.89%** |
| control | treatment_2 | 0.5165 | 0.8705 | 0.8770 | +0.0065 | +0.74% |
| treatment_1 | treatment_2 | **0.003372** | 0.9044 | 0.8770 | -0.0274 | -3.03% |

**Вывод:** Ключевая метрика в группе `treatment_1` статистически значимо выше, чем в группах `control` и `treatment_2`. Группа `treatment_2` не показала значимых отличий от контроля.

#### Задание 2. Вспомогательная метрика 1 — Конверсия из просмотра формы в создание заказа

**График конверсии:**

**Вывод:** Метрика не показала серьёзных отклонений в тестовых группах. Есть различия только в первый день, далее метрика выравнивается.

#### Задание 3. Вспомогательная метрика 2 — Количество поездок на пользователя

**График количества поездок:**

**Вывод:** Изменения в поведении метрики отсутствуют. Количество поездок на пользователя остаётся стабильным во всех группах.

---

## Итоговые выводы по эксперименту

### 1. Основные результаты

| Группа | Ключевая метрика | Барьерная метрика | Статус |
|--------|------------------|-------------------|--------|
| **treatment_1** | +3.89% (p < 0.001) | Не ухудшилась | ✅ Успех |
| **treatment_2** | +0.74% (p = 0.516) | Ухудшается | ❌ Неэффективна |

### 2. Ключевые выводы

1. **Гипотеза подтвердилась** — более точный прогноз времени ожидания действительно повышает качество пользовательского опыта и увеличивает вероятность завершения заказа поездкой.

2. **Лучший вариант — treatment_1**:
   - Статистически значимый рост ключевой метрики на **3.89%** относительно контроля
   - Барьерная метрика (выручка на пользователя) не ухудшилась
   - Вспомогательные метрики стабильны

3. **Вариант treatment_2 неэффективен**:
   - Отсутствие статистически значимого роста ключевой метрики
   - Ухудшение барьерной метрики (выручка на пользователя снижается)
   - Не рекомендуется к внедрению

4. **Эффект соответствует ожиданиям**:
   - Рост конверсии (3.89%) соответствует целевому MDE (4%)
   - Эффект заметный, но не революционный

### 3. Рекомендации

✅ **Внедрить вариант treatment_1 для всех пользователей**

Рекомендуется:
- Постепенный rollout (например, 50% → 100% с мониторингом метрик)
- Дальнейший анализ влияния на различные сегменты пользователей
- Исследование возможности улучшения treatment_2 или его отказ

---

## Презентация результатов (тезисы для старшего аналитика)

1. **Эксперимент показал статистически значимый положительный результат** для группы `treatment_1` в сравнении с группами `control` и `treatment_2`.

2. **Ключевая метрика в варианте `treatment_1` улучшилась на 3.89%** относительно контрольной группы (p < 0.001).

3. **Вспомогательные метрики не показали серьёзного ухудшения** в группе `treatment_1` относительно контроля:
   - Конверсия из просмотра формы в создание заказа стабильна
   - Количество поездок на пользователя не изменилось

4. **Группа `treatment_2` не показала статистически значимых различий** с контрольной группой, при этом барьерная метрика (выручка) ухудшается.

5. **Рекомендовано внедрение фичи для всех пользователей в варианте `treatment_1`**.

---

## Карта эксперимента (заполненная)

| Параметр | Значение |
|----------|----------|
| **Название теста** | A/B/C-тест новой модели прогноза времени ожидания |
| **Дата запуска** | 14.10.2024 |
| **Дата окончания** | 27.10.2024 |
| **Длительность** | 14 дней |
| **Гипотеза** | Более точный прогноз времени ожидания повысит качество пользовательского опыта и увеличит вероятность завершения заказа поездкой |
| **Ключевая метрика** | Конверсия из создания заказа в успешную поездку |
| **Барьерная метрика** | Выручка на пользователя |
| **Вспомогательные метрики** | Конверсия из просмотра формы в создание заказа; Количество поездок на пользователя |
| **MDE (относительный)** | 4% |
| **Уровень значимости** | 0.0167 (с поправкой Бонферрони) |
| **Мощность** | 0.8 |
| **Статистический критерий** | t-тест Стьюдента с линеаризацией |
| **Группы** | control, treatment_1, treatment_2 (33/33/33) |
| **Доля трафика** | 50% |
| **Результат** | ✅ Успех — treatment_1 показал статистически значимый рост (+3.89%) |
| **Рекомендация** | Внедрить treatment_1 для всех пользователей |

---

## Файлы
- `README.md` — описание проекта
- `ab_test_analysis.ipynb` — Jupyter Notebook с полным кодом и визуализациями
